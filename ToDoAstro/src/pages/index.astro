---
import Layout from '../layouts/Layout.astro'; // Importa el layout que se usará para la página
import { tareas } from "../lib/tareas.ts"; // Importa la lista de tareas desde el archivo tareas.ts
import '../styles/global.css';

//const todasLasTareas = Astro.locals.tareas ?? [];
const todasLasTareas = tareas ?? [];
// Se obtiene el filtro de la URL, por defecto es "todas"
const filtro = Astro.url.searchParams.get("filtro") ?? "todas";

// Se filtran las tareas según el filtro seleccionado
let tareasFiltradas = todasLasTareas
  .map((t, index) => ({ ...t, id: index })); // añade índice original

if (filtro === "completadas" || filtro === "completed") { // Filtra las tareas completadas
  tareasFiltradas = tareasFiltradas.filter(t => t.completada);
} else if (filtro === "incompletas" || filtro === "incomplete") { // Filtra las tareas incompletas
  tareasFiltradas = tareasFiltradas.filter(t => !t.completada); 
}

---

<Layout>

  <div class="max-w-xl mx-auto mt-12 bg-white p-6 rounded-xl shadow-md text-center">
    <h1 class="text-3xl text-gray-800 mb-6"><span class="text-pink-300">TO</span>DO</h1>
  
        <!-- Filtros -->
    <div id="filtros-form" class="flex justify-center gap-2 mb-6">
      <a href="/?filtro=todas" data-filtro="todas"
        class={`px-4 py-2 rounded-full text-sm font-bold transition ${filtro === 'todas' || filtro === 'all' ? 'bg-green-300 text-white' : 'bg-gray-100'}`}>
        All
      </a>
      <a href="/?filtro=incompletas" data-filtro="incompletas"
        class={`px-4 py-2 rounded-full text-sm font-bold transition ${filtro === 'incompletas' || filtro === 'incomplete' ? 'bg-green-300 text-white' : 'bg-gray-100'}`}>
        Incomplete
      </a>
      <a href="/?filtro=completadas" data-filtro="completadas"
        class={`px-4 py-2 rounded-full text-sm font-bold transition ${filtro === 'completadas' || filtro === 'completed' ? 'bg-green-300 text-white' : 'bg-gray-100'}`}>
        Completed
      </a>
    </div>
  
    <!-- Agregar tarea -->
    <form method="POST" action="/api/agregar" class="flex gap-2 justify-center mb-6">
      <input type="text" name="texto" placeholder="What do you need to do?" required
        class="w-3/4 px-4 py-2 border border-gray-300 rounded-full focus:outline-none text-base" />
      <button type="submit"
        class="bg-blue-300 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-400 transition">ADD</button>
    </form>
  
    <!-- Lista de tareas -->
    <div id="tareas-container">
      {tareasFiltradas.map((tarea) => (
        <div class="flex items-center justify-between bg-gray-100 px-4 py-2 rounded-lg">
          <form method="POST" action={`/api/toggle/${tarea.id}`}>
            <button type="submit" class="bg-pink-300 text-white px-3 py-1 rounded-full text-lg font-bold">
              {tarea.completada ? "✓" : "○"}
            </button>
          </form>
          <div class={`flex-1 mx-3 text-base text-left ${tarea.completada ? 'line-through text-gray-400' : ''}`}>
            {tarea.texto}
          </div>
          <form method="POST" action="/api/eliminar">
            <input type="hidden" name="id" value={tarea.id} />
            <button type="submit" class="bg-pink-300 text-white px-3 py-1 rounded-full text-lg font-bold">✕</button>
          </form>
        </div>
      ))}
    </div>
  
    <!-- Botón limpiar completadas -->
    <form method="POST" action="/api/limpiar" class="mt-6">
      <button type="submit"
        class="text-green-500 hover:underline text-sm font-medium">Clear Completed</button>
    </form>
  </div>

  <noscript>
    <div class="bg-yellow-100 text-yellow-800 p-3 rounded-md my-4 text-sm">
      JavaScript está desactivado. Algunas funcionalidades se recargarán la página, pero la aplicación sigue funcionando correctamente.
    </div>
  </noscript>
  
</Layout>


<script type="module" src="/src/scripts/main.js"></script>