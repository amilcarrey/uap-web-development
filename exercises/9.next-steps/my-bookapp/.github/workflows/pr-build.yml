name: PR ‚Äì Build Check

# DESCRIPCI√ìN DEL WORKFLOW:
# Este workflow verifica que la aplicaci√≥n se pueda compilar exitosamente
# antes de permitir el merge de un Pull Request.
#
# QU√â HACE:
# 1. Ejecuta build en m√∫ltiples versiones de Node.js (18 y 20)
# 2. Instala dependencias con cache optimizado
# 3. Compila la aplicaci√≥n Next.js para producci√≥n
# 4. Comenta resultados autom√°ticamente en el PR
# 5. Bloquea el merge si el build falla

on:
  pull_request:
    branches: [main, master]  # Se ejecuta cuando se abre/actualiza PR hacia main

permissions:
  contents: read              # Permiso para leer el c√≥digo del repositorio
  pull-requests: write        # Permiso para comentar en Pull Requests

jobs:
  build:
    name: Build (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Contin√∫a con otras versiones aunque una falle
      matrix:
        node: [18, 20]  # Prueba en Node.js 18 LTS y 20 LTS para compatibilidad

    steps:
      # PASO 1: Descargar c√≥digo fuente del Pull Request
      - name: Checkout
        uses: actions/checkout@v4

      # PASO 2: Configurar versi√≥n espec√≠fica de Node.js con cache de npm
      # El cache accelera builds subsecuentes al reutilizar dependencias
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm  # Cache autom√°tico de node_modules basado en package-lock.json

      # PASO 3: Instalar dependencias exactas basadas en package-lock.json
      # npm ci es m√°s r√°pido y confiable que npm install para CI/CD
      - name: Install
        run: npm ci

      # PASO 4: Cache espec√≠fico de Next.js build 
      # Reutiliza archivos compilados entre builds para mayor velocidad
      - name: Cache Next build cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: next-${{ runner.os }}-${{ matrix.node }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            next-${{ runner.os }}-${{ matrix.node }}-
            next-

      # PASO 5: Compilar aplicaci√≥n para producci√≥n
      # Este es el paso cr√≠tico - si falla, el PR no puede mergearse
      - name: Build
        env:
          NODE_ENV: production                    # Compilaci√≥n optimizada
          NODE_OPTIONS: --max_old_space_size=4096 # M√°s memoria para builds grandes
        run: npm run build

      # PASO 6: Comentar √©xito en PR (solo para Node 20 para evitar duplicados)
      - name: Comment PR Build Success
        if: success() && matrix.node == 20
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Build exitoso!**\n\n' +
                    '- Compilaci√≥n exitosa en Node.js 18 y 20\n' +
                    '- todas las dependencias instaladas correctamente\n' +
                    '- Aplicaci√≥n lista para producci√≥n\n' +
                    '- Cache optimizado para builds futuros\n\n' +
                    '**Tu c√≥digo est√° listo para merge!** üéâ'
            })
            
      # PASO 7: Comentar error en PR (solo para Node 20 para evitar duplicados)
      - name: Comment PR Build Failure
        if: failure() && matrix.node == 20
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Build fall√≥!**\n\n' +
                    '**Posibles causas:**\n' +
                    '- Error de sintaxis en TypeScript/JavaScript\n' +
                    '- Dependencia faltante o incompatible en package.json\n' +
                    '- Error en configuraci√≥n de Next.js\n' +
                    '- Problema con variables de entorno\n' +
                    '- Error de tipos en TypeScript\n\n' +
                    '**[Ver detalles del error](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})**\n\n' 
            })
